@page "/employees"

@using Management
@using Management.Inputs
@using MudBlazor
@using Management.Outputs

@inject IEmployeeSdk employeeSdk
@inject NavigationManager Navigation

<PageTitle>Employees</PageTitle>

<MudContainer Class="d-flex justify-center align-center" Style="height: 100vh; margin-top: 20px;">
    <MudGrid Justify="Justify.Center" AlignItems="AlignItems.Center">
        <MudItem xs="12" sm="8" md="6" lg="12">
            <MudPaper Class="pa-4">       
                <MudText Typo="Typo.h3" Align="Align.Center" Class="mb-4" Style="color: black; text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);">Employees</MudText>

                <MudTable Items="employees" Striped="true" Hover="true" Bordered="true" Breakpoint="Breakpoint.Md">
                    <HeaderContent>
                        <MudTh>ID</MudTh>
                        <MudTh>Name</MudTh>
                        <MudTh>Apellido</MudTh>
                        <MudTh>DUI</MudTh>
                        <MudTh>Actions</MudTh>
                    </HeaderContent>
                    <RowTemplate>
                        <MudTd DataLabel="ID">@context.Id</MudTd>
                        <MudTd DataLabel="Name">@context.FirstName</MudTd>
                        <MudTd DataLabel="Apellido">@context.LastName</MudTd>
                        <MudTd DataLabel="DUI">@context.Dui</MudTd>
                        <MudTd DataLabel="Actions">
                            <MudButton Variant="Variant.Filled" Color="Color.Primary" ButtonType="ButtonType.Submit">Edit</MudButton>
                            <MudButton Variant="Variant.Filled" Color="Color.Error" ButtonType="ButtonType.Submit">Delete</MudButton>
                        </MudTd>
                    </RowTemplate>
                </MudTable>
            </MudPaper>
        </MudItem>
    </MudGrid>
</MudContainer>

@code {
    private List<EmployeeOutput> employees = new List<EmployeeOutput>();

    protected override async Task OnInitializedAsync()
    {
        await GetAllEmployeesWithoutFilter();
    }

    public async Task GetAllEmployeesWithoutFilter()
    {
        List<EmployeeOutput> allEmployees = new List<EmployeeOutput>();
        int page = 1;
        int pageSize = 10;

        while (true)
        {
            var filter = new EmployeeGetFilter(
                NameContains: null,  
                Page: page,
                ItemsPerPage: pageSize
                );

            try
            {
                var paginatedEmployees = await employeeSdk.GetEmployeesByFilter(filter);

               
                if (paginatedEmployees.Items.Any())
                {
                    allEmployees.AddRange(paginatedEmployees.Items); 
                    page++;
                }
                else
                {
                    break; 
                }
            }
            catch (Exception ex)
            {
                Console.WriteLine($"Error al obtener los empleados: {ex.Message}");
                break; 
            }
        }

        employees = allEmployees;
    }

  
    private void EditEmployee(string employeeId)
    {
        Navigation.NavigateTo($"/edit-employee/{employeeId}");
    }

  
    private async Task DeleteEmployee(string employeeId)
    {
        try
        {
            await employeeSdk.DeleteEmployee(employeeId);
            await GetAllEmployeesWithoutFilter(); 
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error deleting employee: {ex.Message}");
        }
    }
}